{% extends "layouts/base-fullscreen.html" %}

{% block title %} Sign UP {% endblock %} 

<!-- Specific CSS Plugins goes HERE  -->
{% block css_plugins %}{% endblock css_plugins %}


<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %} 




<div id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-4">
            <h1 class="mt-4">TRAFFIC FLOW</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item active">Dashboard</li>
            </ol>
            <div class="row">
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-primary text-white mb-4">
                        <div class="card-body text-center">Vehicle Count</div>
                       
                        <div class="card-body text-center"> <h1 id="total">{{total}}</h1></div>

                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-warning text-white mb-4">
                        <div class="card-body text-center">Cars</div>
                        <div class="card-body text-center"> <h1 id="car">{{car}}</h1></div>

                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-success text-white mb-4">
                        <div class="card-body text-center">Buses</div>
                        <div class="card-body text-center"> <h1 id="bus">{{bus}}</h1></div>

                        
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-danger text-white mb-4">
                        <div class="card-body text-center">Bikes</div>
                        <div class="card-body text-center"> <h1 id="bike">{{bike}}</h1></div>

                  
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xl-6">
                <div class="card mb-4">
                    <img id="stream" src="" width="100%" height="100%" />
                </div>
                </div>  
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-chart-pie me-1"></i>
                        </div>
                        <div class="card-body"><canvas id="myPieChart" width="100%" height="50"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>


{% endblock content %}

<!-- Specific JS Plugins goes HERE  -->
{% block js_plugins %}



<script src="{{ url_for('static', path='/assets/demo/chart-pie-demo.js') }}"></script>

{% endblock js_plugins %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script>
    Chart.defaults.global.defaultFontFamily = '-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif';
Chart.defaults.global.defaultFontColor = '#292b2c';

// Pie Chart Example
var client = new Paho.MQTT.Client("broker.hivemq.com", Number(8000), "VehicleReceiver123");
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    console.log('client created')
    // Set up the variables for the counts
    var bikeCount = {{bike}};
    var carCount = {{car}};
    var busCount = {{bus}};
    var totalCount = {{total}};
    var bike = document.getElementById('bike')
    var car = document.getElementById('car')
    var bus = document.getElementById('bus')
    var total = document.getElementById('total')
    // Called when the client connects
    function onConnect() {
        console.log("Connected to MQTT broker!");

        // Subscribe to the "kgx-vehicle" topic
        client.subscribe("kgx-vehicle");
    }
    try {
        client.connect({
            userName: "myuser",
            password: "password", 
            onSuccess: onConnect, 
            onFailure: function (message) {
                console.log("Connection failed: " + message.errorMessage);
            }
        });
    }
    catch (e) {
        console.log(e)
    }

    // Called when the client loses its connection
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Connection lost: " + responseObject.errorMessage);
        }
    }

    // Called when a message arrives
    function onMessageArrived(message) {
        console.log("Message received: " + message.payloadString);

        // Check if the message contains "Bike", "Car", or "Bus"
        if (message.payloadString.includes("Bike")) {
            bikeCount++;
            totalCount++;
            bike.innerText = `${bikeCount}`;
            total.innerText = `${totalCount}`;
        }
        if (message.payloadString.includes("Car")) {
            carCount++;
            totalCount++;
            car.innerText = `${carCount}`;
            total.innerText = `${totalCount}`;
        }
        if (message.payloadString.includes("Bus")) {
            busCount++
            totalCount++;
            bus.innerText = `${busCount}`;
            total.innerText = `${totalCount}`;
        }

        // Log the updated counts
        console.log("Bike count: " + bikeCount);
        console.log("Car count: " + carCount);
        console.log("Bus count: " + busCount);
        console.log("Total Count: " + totalCount);
    }
var ctx = document.getElementById("myPieChart");

var myPieChart = new Chart(ctx, {
  type: 'pie',
  data: {
    labels: ["Car", "Bus", "Bike",],
    datasets: [{
      data: [carCount,busCount,bikeCount],
      backgroundColor: ['#ffc107','#198754', '#dc3545', ],
    }],
  },
});

const streamImg = document.getElementById("stream");
        const ws = new WebSocket("ws://localhost:8000/ws");

        ws.onmessage = (event) => {
            const blob = new Blob([event.data], { type: 'image/jpeg' });
            const url = URL.createObjectURL(blob);
            streamImg.src = url;
        };

  

</script>


{% endblock javascripts %}