<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Video Stream</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

</head>

<body>
    <h1>Video Stream</h1>
    <p id="bike"></p>
    <p id="car"></p>
    <p id="bus"></p>
    <p id="total"></p>
    <img id="video_feed" src="/web/video_feed" width="640" height="400" />
</body>
<script>
    var client = new Paho.MQTT.Client("127.0.0.1", Number(9001), "VehicleReceiver123");
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    console.log('client created')
    // Set up the variables for the counts
    var bikeCount = 0;
    var carCount = 0;
    var busCount = 0;
    var totalCount = 0;
    var bike = document.getElementById('bike')
    var car = document.getElementById('car')
    var bus = document.getElementById('bus')
    var total = document.getElementById('total')
    // Called when the client connects
    function onConnect() {
        console.log("Connected to MQTT broker!");

        // Subscribe to the "kgx-vehicle" topic
        client.subscribe("kgx-vehicle");
    }
    try {
        client.connect({
            userName: "myuser",
            password: "password", 
            onSuccess: onConnect, 
            onFailure: function (message) {
                console.log("Connection failed: " + message.errorMessage);
            }
        });
    }
    catch (e) {
        console.log(e)
    }

    // Called when the client loses its connection
    function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("Connection lost: " + responseObject.errorMessage);
        }
    }

    // Called when a message arrives
    function onMessageArrived(message) {
        console.log("Message received: " + message.payloadString);

        // Check if the message contains "Bike", "Car", or "Bus"
        if (message.payloadString.includes("Bike")) {
            bikeCount++;
            totalCount++;
            bike.innerText = `${bikeCount}`;
            total.innerText = `${totalCount}`;
        }
        if (message.payloadString.includes("Car")) {
            carCount++;
            totalCount++;
            car.innerText = `${carCount}`;
            total.innerText = `${totalCount}`;
        }
        if (message.payloadString.includes("Bus")) {
            busCount++
            totalCount++;
            bus.innerText = `${busCount}`;
            total.innerText = `${totalCount}`;
        }

        // Log the updated counts
        console.log("Bike count: " + bikeCount);
        console.log("Car count: " + carCount);
        console.log("Bus count: " + busCount);
        console.log("Total Count: " + totalCount);
    }

</script>

</html>